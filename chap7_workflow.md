# Difyでワークフローを作ろう

前章でエージェントアプリを作ってみました。
エージェントアプリでは、エージェント自身が自律的にやるべきタスクを分解して実行してくれました。
今度は、ワークフローを使ったアプリを開発してみましょう。

Difyでは、ユーザの入力などを処理するノード (ブロック) をGUIで繋ぎ合わせ、複雑な処理ワークフローを実装できます。エージェント同様に、さまざまなツールをワークフロー内で利用できます。
また、構築したワークフローをツール化して、他のエージェントやワークフロー内で再利用することも可能です。

## ワークフローの概要

Difyのワークフローは、あらかじめ決められた手順に沿った作業を自動化したい時に使う「1回実行して結果を返す」タイプのアプリです。

以下のようなものに対して、有効に使えると思います。

- アンケート結果分析
- レポート作成
- メール送信
- 申請処理自動化
- 議事録要約

## 本ハンズオンで開発するワークフロー

今回はこんな構成にしたいと思います。

![Dify ワークフロー 全体フロー](/images/books/pyml-niigata-dify/dify_workflow_all.png "Dify ワークフロー 全体フロー")

最初にユーザからの入力を受け付けます。
ユーザの入力を3つに分類して処理を分岐させ、それぞれのユースケースに沿った処理を実行します。
1. 社内システムやIT環境に関する質問は、RAGチャットボットで構築したナレッジベースを用いて、RAGで回答します。
2. アカウント申請については、入力内容からアカウント申請対象のユーザ名やシステム名を抽出して、外部システムに対してHTTPリクエストを実行します。
3. それ以外の場合は、ユーザに対してエラーメッセージを回答します。

## ワークフローの開発

1. Difyの画面上部にある「スタジオ」をクリックし、「アプリを作成する」欄の「最初から作成」をクリックします。
    ![Dify ワークフロー作成](/images/books/pyml-niigata-dify/dify_chatbot_create.png "Dify ワークフロー作成")
2. 「アプリタイプを選択」の中から「ワークフロー」をクリックします。
3. 「アプリのアイコンと名前」のテキストボックスに適当なアプリ名を入力して「作成する」をクリックします。
    ![Dify ワークフロー作成 初期画面](/images/books/pyml-niigata-dify/dify_workflow_init.png "Dify ワークフロー作成 初期画面")
4. オーケストレーション画面が表示されます。今までと違い、ワークフロー開発画面の構成になっています。中央のワークフロー編集部分を用いて、さまざまなノードを作成し繋ぎ合わせることでアプリケーションを構築していきます。
    ![Dify ワークフロー オーケストレーション](/images/books/pyml-niigata-dify/dify_workflow_orchestration_home.png "Dify ワークフロー オーケストレーション")

### ワークフロー開発: 質問の分類まで

まず、ユーザの入力を受け付けた後、その内容を分類してワークフローを分岐させるまでを作成します。

1. 「開始」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
2. 画面右側のモーダルの「入力フィールド」右側にある「+」ボタンをクリックします。
3. 以下の内容を設定し「保存」をクリックします。
    - フィールドタイプ: 「段落」を選択
    - 変数名: query
    - ラベル名: 問合せ内容
    - 最大長: 500
    - 必須: チェックを入れる
    ![Dify ワークフロー 開始ノード1](/images/books/pyml-niigata-dify/dify_workflow_dev_start1.png "Dify ワークフロー 開始ノード1")
    ![Dify ワークフロー 開始ノード2](/images/books/pyml-niigata-dify/dify_workflow_dev_start2.png "Dify ワークフロー 開始ノード2")
4. ノードの後続処理を作成します。今回は開始ノードの右端の「+」マークをクリックし、「質問分類器」をクリックします。
    ![Dify ワークフロー 開始ノード3](/images/books/pyml-niigata-dify/dify_workflow_dev_start3.png "Dify ワークフロー 開始ノード3")
5. 「質問分類器」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
6. 画面右側のモーダルに、以下の内容を設定します。
    - モデル: Anthropic Claudeを選択し、 `Claude 3.7 Sonnet` になっていることを確認
        - AWSアカウントがない方はOpenAIの `gpt-4o-mini` 等を選択してください。
    - 入力変数: `開始 / query`
        - 入力欄をクリックし、ドロップダウンから選択
    - クラス1
        ```
        社内システムやIT環境についての質問
        ```
    - クラス2
        ```
        アカウントの申請
        ```
    - クラス3
        ```
        その他
        ```
    - 「クラスを追加」ボタンをクリックすると、クラスを増やすことができます
    ![Dify ワークフロー 分類器ノード1](/images/books/pyml-niigata-dify/dify_workflow_dev_classification1.png "Dify ワークフロー 分類器ノード1")

これで、入力した文字列を3つのカテゴリのどれかに分類し、それぞれ枝分かれしたワークフロー処理を設定する準備ができました。

### ワークフロー開発: RAGでの回答

最初の分類処理フローを構築します。

1. 「質問分類器」ノードの「社内シウテムやIT環境についての質問」クラスの右端の「+」マークをクリックし、「知識検索」をクリックします。
    ![Dify ワークフロー 分類器ノード2](/images/books/pyml-niigata-dify/dify_workflow_dev_classification2.png "Dify ワークフロー 分類器ノード2")
2. 「知識検索」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
3. 画面右側のモーダルに、以下の内容を設定します。
    - 検索変数: `開始 / query`
        - 入力欄をクリックし、ドロップダウンから選択
    - ナレッジベース: `社内文書`
        - ナレッジベース右横の「+」ボタンをクリックして選択
    ![Dify ワークフロー RAG1](/images/books/pyml-niigata-dify/dify_workflow_dev_rag1.png "Dify ワークフロー RAG1")
4. 「知識検索」ノードの右端の「+」マークをクリックし、「LLM」をクリックします。
5. 「LLM」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
6. 画面右側のモーダルに、以下の内容を設定します。
    - AIモデル: Anthropic Claudeを選択し、 `Claude 3.7 Sonnet` になっていることを確認
        - AWSアカウントがない方はOpenAIの `gpt-4o-mini` 等を選択してください。
    - コンテキスト: `知識検索 / result`
        - 入力欄をクリックし、ドロップダウンから選択
    - SYSTEM
        ```
        ユーザーの入力に対して、 <context> 内の内容に基づいて回答してください。
        <context>
        {{#context#}}
        </context>
        ```
        - 生成AIモデルに対してのシステムプロンプト
    - USER
        - `開始 / query`
            - 「メッセージを追加」をクリックし、USERプロンプト入力欄を追加します
            - `/` を入力すると埋め込める変数の一覧が表示されるので `開始 / query` を選択します
    ![Dify ワークフロー RAG2](/images/books/pyml-niigata-dify/dify_workflow_dev_rag2.png "Dify ワークフロー RAG2")
7. 「LLM」ノードの右端の「+」マークをクリックし、「終了」をクリックします。
8. 「終了」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
9. 画面右側のモーダルに、以下の内容を設定します。
    - 出力変数
        - output: `LLM / text`
        - result: `知識検索 / result`
        - 「出力変数」の右の「+」ボタンをクリックして設定します
    ![Dify ワークフロー RAG3](/images/books/pyml-niigata-dify/dify_workflow_dev_rag3.png "Dify ワークフロー RAG3")

これで、最初の分岐のRAG部分のフローができました。

### ワークフロー開発: 外部システムリクエスト

1. 「質問分類器」ノードの「アカウントの申請」クラスの右端の「+」マークをクリックし、「パラメータ抽出」をクリックします。
    ![Dify ワークフロー 分類器ノード3](/images/books/pyml-niigata-dify/dify_workflow_dev_classification3.png "Dify ワークフロー 分類器ノード3")
2. 「パラメータ抽出」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
3. 画面右側のモーダルに、以下の内容を設定します。
    - モデル: Anthropic Claudeを選択し、 `Claude 3.7 Sonnet` になっていることを確認
        - AWSアカウントがない方はOpenAIの `gpt-4o-mini` 等を選択してください。
    - 入力変数: `開始 / query`
        - 入力欄をクリックし、ドロップダウンで選択
    - パラメータを抽出:
        - 「パラメータを抽出」の右の「+」ボタンをクリックして、詳細を設定
        - 1つ目
            - 名前: `username`
            - タイプ: String (デフォルト)
            - 説明:
                ```
                アカウント申請対象ユーザのユーザ名。

                ユーザ名は半角英数字のみで構成されます。
                明確な人名に紐付くものであり、抽象的なユーザ名にはなりません (NG例: admin)。
                ユーザの入力に含まれる文字列しか抽出してはいけません。
                ```
            - 必須: 有効
        - 2つ目
            - 名前: `system_name`
            - タイプ: String (デフォルト)
            - 説明:
                ```
                アカウント申請対象のシステム名。
                
                以下のいずれかである必要があります。
                - "hr" : 人事システム
                - "kintai" : 勤怠管理システム
                - "dev" : 開発環境
                - "aws" : AWS アカウント"
                - "gcp" : Google Cloud アカウント"
                ```
            - 必須: 有効
    - 指示:
        ```
        ユーザーの入力から、アカウント申請の対象システム名 (system_name) と対象ユーザ名 (username) を抽出してください。
        ```
    ![Dify ワークフロー WebRequest1](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest1.png "Dify ワークフロー WebRequest1")
    ![Dify ワークフロー WebRequest2](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest2.png "Dify ワークフロー WebRequest2")
    ![Dify ワークフロー WebRequest3](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest3.png "Dify ワークフロー WebRequest3")
4. 「パラメータ抽出」ノードの右端の「+」マークをクリックし、「HTTPリクエスト」をクリックします。
    ![Dify ワークフロー WebRequest4](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest4.png "Dify ワークフロー WebRequest4")
5. 「HTTPリクエスト」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
6. 画面右側のモーダルに、以下の内容を設定します。
    - API
        - GET
        - （当日、ハンズオン講師より指定されたURLを入力ください）
    - パラメータ
        1. キー: username
            - 値: `パラメータ抽出 / username`
        2. キー: system_name
            - 値: `パラメータ抽出 / system_name`
        - 表内にそれぞれ入力します
        - 値を入力する際は、 `/` を入力すると変数がサジェストされます
        - 表の行が増えない場合は、一旦フォーカスを別のところにしたり、最後の行の値欄をクリックしたりすると、表の行が増えることがあります
    ![Dify ワークフロー WebRequest5](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest5.png "Dify ワークフロー WebRequest5")
7. 「HTTPリクエスト」ノードの右端の「+」マークをクリックし、「終了」をクリックします。
8. 「終了」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
9. 画面右側のモーダルに、以下の内容を設定します。
    - 出力変数
        - output: `HTTPリクエスト / body`
        - system_name: `パラメータ抽出 / system_name`
        - username: `パラメータ抽出 / username`
        - 「出力変数」の右の「+」ボタンをクリックして設定します
    ![Dify ワークフロー WebRequest6](/images/books/pyml-niigata-dify/dify_workflow_dev_webrequest6.png "Dify ワークフロー WebRequest6")

これで、2番目の分岐の外部システムへのリクエスト部分のフローができました。

### ワークフロー開発: その他

最後に想定以外の入力を処理するフローを構築します。

1. 「質問分類器」ノードの「その他」クラスの右端の「+」マークをクリックし、「テンプレート」をクリックします。
    ![Dify ワークフロー 分類器ノード4](/images/books/pyml-niigata-dify/dify_workflow_dev_classification4.png "Dify ワークフロー 分類器ノード4")
2. 「テンプレート」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
3. 画面右側のモーダルに、以下の内容を設定します。
    - 入力変数
        - 変数名: query
        - 変数値: `開始 / query`
    - コード
        ```
        申し訳ありませんが、現在このワークフローは以下にのみ対応しています。
        - 社内システムやIT環境についての質問
        - アカウントの申請

        それ以外のお問い合わせは直接情報システム部にご連絡ください。

        ※頂いたお問い合わせ内容:
        {{ query }}
        ```
    ![Dify ワークフロー 例外処理1](/images/books/pyml-niigata-dify/dify_workflow_dev_exception1.png "Dify ワークフロー 例外処理1")
4. 「テンプレート」ノードの右端の「+」マークをクリックし、「終了」をクリックします。
5. 「終了」ノードをクリックします。
    - 画面右側にノードの詳細を編集するモーダルが表示されます。
6. 画面右側のモーダルに、以下の内容を設定します。
    - 出力変数
        - output: `テンプレート / output`
        - 「出力変数」の右の「+」ボタンをクリックして設定します
    ![Dify ワークフロー 例外処理2](/images/books/pyml-niigata-dify/dify_workflow_dev_exception2.png "Dify ワークフロー 例外処理2")

これで、最後の分岐のワークフローが完成し、全てのワークフローができ上がりました。

## ワークフローの保存

作成したワークフローは忘れずに保存しましょう。
画面右上の「公開する」をクリックし、「更新を公開」をクリックします。

![Dify ワークフロー 保存](/images/books/pyml-niigata-dify/dify_workflow_dev_save.png "Dify ワークフロー 保存")

また、出来上がったワークフローなどのアプリケーションは、基本情報の項目の「…もっと」をクリックし「DSLをエクスポート」をクリックすることで、定義情報ファイル(YAML)をダウンロードできます。
この定義情報ファイルは「DSLをインポート」することで、再現することも可能です。
ただし、ナレッジベースやチャットアプリに設定したFAQ等はエクスポート・インポートできませんので、ご注意ください。

![Dify ワークフロー エクスポート](/images/books/pyml-niigata-dify/dify_workflow_dev_export.png "Dify ワークフロー エクスポート")

## ワークフローのテスト

作成したワークフローをテストしてみましょう。

1. 画面上部右側の「▷実行」をクリックします。
    - テスト実行のモーダルが表示されます。
2. 問合せ内容の欄に以下のプロンプトを入力し「実行の開始」をクリックします。
    ```
    有給休暇の申請方法
    ```
    ![Dify ワークフロー テスト1](/images/books/pyml-niigata-dify/dify_workflow_test1.png "Dify ワークフロー テスト1")
3. ユーザの入力をもとにワークフローが起動します。うまくいけば最初の分岐のフローで処理が実行され、最終的な結果出力も表示されます。実際に処理が実行されたフローも色で表しています。
    ![Dify ワークフロー テスト2](/images/books/pyml-niigata-dify/dify_workflow_test2.png "Dify ワークフロー テスト2")
    - たまに、質問内容がLLMによって誤って分類されて、意図しない別のフローに遷移するケースがあります。同じプロンプトでも、再実行すると分類結果が変わり正しく遷移することもあります。この場合、「質問分類器」ノードのクラス名の改善やパラメータの変更等を行い、精度を上げられるか試してみましょう。「高度な設定」内に「指示」という項目にシステムプロンプトを入力することも可能です。
    ![Dify ワークフロー テスト3](/images/books/pyml-niigata-dify/dify_workflow_test3.png "Dify ワークフロー テスト3")
4. より詳細に実行結果を確認する場合は「詳細情報」タブをクリックします。
    ![Dify ワークフロー テスト4](/images/books/pyml-niigata-dify/dify_workflow_test4.png "Dify ワークフロー テスト4")
5. ワークフロー内の各ノードでの入力・処理・出力の内容も確認できます。「実行追跡」タブをクリックすると、実行内容がトレースできます。
    ![Dify ワークフロー テスト5](/images/books/pyml-niigata-dify/dify_workflow_test5.png "Dify ワークフロー テスト5")
6. 「入力」タブをクリックすると再びワークフローへの入力を行うことができます。続いて2番目の分岐の動作確認をしましょう。問合せ内容の欄に以下のプロンプトを入力し「実行の開始」をクリックします。
    ```
    人事システムに田中のアカウントを作成してください
    ```
    ![Dify ワークフロー テスト6](/images/books/pyml-niigata-dify/dify_workflow_test6.png "Dify ワークフロー テスト6")
7. ユーザの入力をもとにワークフローが起動します。うまくいけば2番目の分岐のフローで処理が実行され、最終的な結果出力も表示されます。実際に処理が実行されたフローも色で表しています。
    ![Dify ワークフロー テスト7](/images/books/pyml-niigata-dify/dify_workflow_test7.png "Dify ワークフロー テスト7")
8. 最後に残りの分岐の動作確認をしましょう。「入力」タブをクリックし、問合せ内容の欄に以下のプロンプトを入力し「実行の開始」をクリックします。
    ```
    明日の新潟の天気は？
    ```
    ![Dify ワークフロー テスト8](/images/books/pyml-niigata-dify/dify_workflow_test8.png "Dify ワークフロー テスト8")
9. ユーザの入力をもとにワークフローが起動します。うまくいけば最後の分岐のフローで処理が実行され、最終的な結果出力も表示されます。実際に処理が実行されたフローも色で表しています。
    ![Dify ワークフロー テスト9](/images/books/pyml-niigata-dify/dify_workflow_test9.png "Dify ワークフロー テスト9")

### 過去の実行履歴の確認

Difyのワークフロー編集画面のテスト履歴は、過去に遡って参照することができます。

画面上部の実行の右隣にある、時計アイコンをクリックします。保持されている実行履歴が一覧で表されます。確認したいテスト実行をクリックすると、その詳細を確認できます。
![Dify ワークフロー テスト10](/images/books/pyml-niigata-dify/dify_workflow_test10.png "Dify ワークフロー テスト10")

テスト実行時のワークフロー構成と、実行の詳細等を確認でき、ワークフローの改善に役立てることができます。

![Dify ワークフロー テスト11](/images/books/pyml-niigata-dify/dify_workflow_test11.png "Dify ワークフロー テスト11")

なお、「編集に戻る」で元の画面に戻れます。

## 補足: チャットフローとは何か？

ワークフローとは別に「チャットフロー」というアプリタイプがDifyには用意されています。
これは、会話のやり取りをしながらタスクをこなすような、複雑なワークフローを想定されている場合に最適です。

今回のハンズオンでは扱いませんが、これを使いこなすとより柔軟性の高いチャットアプリケーションが構築できます。

ちなみに、今回作成したRAGチャットボットは、以下のようなチャットフローで置き換えることができます。

![Dify チャットフロー サンプル](/images/books/pyml-niigata-dify/dify_chatflow_sample.png "Dify チャットフロー サンプル")
