# Difyでエージェントアプリを開発しよう

前章でRAGチャットボットアプリを作ってみました。
今度は、エージェントを使ったアプリを開発してみましょう。

## エージェントとは何か？

生成AIエージェントとは、生成AIを使って自律的にタスクを実行する高度なAIアプリケーションの事です。ユーザの入力に対し、自律的に行うべきタスクを考え、実際にそれを実行し、与えられたタスクや課題を最終的に遂行したり解決したりすることができます。

エージェントができることは「タスク分解」です。
ユーザの入力を複数の小さなタスクに分割し、タスクごとに適切なツールを呼び出して回答を生成します。

例として、エージェントに以下のツールを事前に与えておきます。

- 会社名から銘柄コードを取得するツール
- 銘柄コードから株価を取得するツール

そして、エージェントへの指示として「ユーザの入力を受けたら、ユーザの代わりにツールを駆使して入力に対する回答を生成する」という役割を、システムプロンプトで与えてあげます。

この設定をしておくことで、エージェントはユーザからの入力をもとにタスクを分解して実行し、回答を生成します。

もしユーザから「ABC社の現在の株価を教えてください」と入力があったら、エージェントでは以下のように行動します。

1. 文脈から「ABC社」が企業名であると判断する
2. [会社名から銘柄コードを取得] → [銘柄コードから株価を取得] の方法で株価を取得できると判断する
3. `ABC` を入力パラメータとして [会社名から銘柄コードを取得するツール] を実行する
4. 取得できた銘柄コードを入力パラメータとして [銘柄コードから株価を取得するツール] を実行する
5. 取得できた株価をユーザに回答する

## Difyでのエージェント開発

Difyでは、エージェントに与えるツールをプラグインとしてインストールし、利用できます。エージェントにはこれらのツールを与えることで、自律的に行動するアプリケーションを簡単に構築できます。

プラグインとして、プリインストールされた組み込みプラグインだけでなく、[Dify Marketplace](https://marketplace.dify.ai/) 上で公開されているプラグインやユーザ自身が自作したプラグインも利用できます。

今回はシンプルに「Web検索ツール」を用いて、ユーザの代わりにWeb検索した結果を教えてくれるリサーチエージェントを開発します。

Difyでのエージェント開発は、チャットボット開発と似ています。違いは、エージェントにはツールを与えて実行させることができるという点です。

## ツールプラグインのインストール

今回は「DuckDuckGo」 (ユーザのプライバシーを重視した検索エンジン) のプラグインをインストールします。

1. Difyの画面上部にある「ツール」をクリックします。
    - 画面上部にはインストール済のツールプラグインが表示され、下部には[Dify Marketplace](https://marketplace.dify.ai/)上に公開されているツールプラグインが表示されています。
    ![Dify ツール](/images/books/pyml-niigata-dify/dify_tools_home.png "Dify ツール")
2. 「DuckDuckGo」プラグインを探して、DuckDuckGoのパネルにマウスカーソルを合わせると「インストール」ボタンと「詳細」ボタンが表示されます。「インストール」をクリックします。
    ![Dify DuckDuckGo インストール1](/images/books/pyml-niigata-dify/dify_tools_duckduckgo_install1.png "Dify DuckDuckGo インストール1")
3. プラグインをインストールするか聞かれるので、「インストール」をクリックします。
    - インストールされたプラグインは画面上部に表示されます。
    ![Dify DuckDuckGo インストール2](/images/books/pyml-niigata-dify/dify_tools_duckduckgo_install2.png "Dify DuckDuckGo インストール2")
4. DuckDuckGoのパネルをクリックすると、APIキー等の入力欄がなく、設定は特に不要で利用可能であることがわかります。また、内包するツールとして「Web検索」「画像検索」「翻訳」などを提供していることがわかります。
    ![Dify DuckDuckGo 詳細](/images/books/pyml-niigata-dify/dify_tools_duckduckgo_desc.png "Dify DuckDuckGo 詳細")

### 補足: Google検索やBing検索

他にも、Google検索やBing検索のツールプラグインもあります。

Google検索は、[SerpApi](https://serpapi.com/)にユーザ登録してAPIキーを取得し、そのキーをプラグインに設定する必要があります。

Bing検索は、AzureにてAPIキーを取得し、そのキーをプラグインに設定する必要があります。

今回は設定が楽な DuckDuckGo を利用しますが、必要に応じてツールを変更していただいても構いません。

## エージェントアプリケーションの開発

1. Difyの画面上部にある「スタジオ」をクリックし、「アプリを作成する」欄の「最初から作成」をクリックします。
    ![Dify チャットボット作成](/images/books/pyml-niigata-dify/dify_chatbot_create.png "Dify チャットボット作成")
2. 「アプリタイプを選択」の中から小さく書かれた「初心者向けの基本的なアプリタイプ」をクリックし「エージェント」をクリックします。
3. 「アプリのアイコンと名前」のテキストボックスに適当なアプリ名を入力して「作成する」をクリックします。
    ![Dify エージェント作成 初期画面](/images/books/pyml-niigata-dify/dify_agent_init.png "Dify エージェント作成 初期画面")
4. オーケストレーション画面が表示されます。チャットボットとの違いは「ツール」欄があるのみです。右側のモデル名をクリックしましょう。
    ![Dify エージェント オーケストレーション](/images/books/pyml-niigata-dify/dify_agent_orchestration_home.png "Dify エージェント オーケストレーション")
5. 以下の設定をします。
    - モデル: Anthropic Claude
    - パラメータ
        - Bedrock Model: Claude 3.7 Sonnet
        - Use Cross-Region Inference: True (デフォルト)
        - 他デフォルトのままでOKです
    ![Dify チャットボット モデル設定](/images/books/pyml-niigata-dify/dify_chatbot_model_settings.png "Dify チャットボット モデル設定")
    - OpenAIを利用する場合は、モデルを「gpt-4o-mini」あたりを指定しましょう。
        - パラメータは「プリセットの読み込み」からお好きな設定を指定しましょう。
6. ツール欄の「+ 追加」をクリックし、DuckDuckGoプラグインをクリックすると、その中に含まれるツール群が表示されるので「DuckDuckGo Search」をクリックします。
    - ツール欄に「DuckDuckGo Search」が追加されます。
    ![Dify エージェント ツール追加](/images/books/pyml-niigata-dify/dify_agent_add_tools.png "Dify エージェント ツール追加")
7. 「プロンプト」欄に、エージェントへの指示として、検索してユーザの質問に回答する指示を与えます。
    ```text
    あなたはリサーチエージェントです。
    ユーザからの質問を受け取ったら、duckduckgo を使ってWeb検索して回答してください。
    ```
    ![Dify エージェント プロンプト](/images/books/pyml-niigata-dify/dify_agent_prompt.png "Dify エージェント プロンプト")
8. デバッグとプレビュー欄下部にある「有効な機能」の「管理 →」をクリックし、「会話の開始」を有効化して「オープナーを書く」をクリックします。
9. エージェント側からの最初のメッセージを設定します。さらにオプションも追加します。設定したら「保存」をクリックします。
    - メッセージ
        ```
        私は、あなたの代わりにWeb検索を行って調査を行うリサーチエージェントです。
        調べたいことを質問してください。
        自由入力でも、選択肢からサンプル質問をクリックする方法でも、質問できます。
        ```
    - オプション
        - Difyとは？
        - Claudeとは？
        - OpenAIとは？
        - AIエージェントとは？
    ![Dify エージェント オープナー](/images/books/pyml-niigata-dify/dify_agent_opener.png "Dify エージェント オープナー")
10. 機能欄の右側にある「×」をクリックして元の画面に戻り、画面右側にあるプレビュー画面でエージェントを体験してみましょう。
    ![Dify エージェント デバッグ](/images/books/pyml-niigata-dify/dify_agent_debug.png "Dify エージェント デバッグ")
11. 「公開する」をクリックして、サイトを最新状態で更新し、サイトを開いて確認してみましょう。

### 補足: エージェントアプリケーションのデバッグ

プレビュー画面でRAGチャットを実行し、チャットボットからの回答にマウスカーソルを合わせて「ドキュメントアイコン」の画像をクリックします。

![Dify エージェント 検索結果確認1](/images/books/pyml-niigata-dify/dify_agent_retrieve1.png "Dify エージェント 検索結果確認1")

プロンプトログが表示されます。「実行追跡」タブでは、ユーザの入力とエージェントの出力、出力に関するメタデータを確認できます。

![Dify エージェント 検索結果確認2](/images/books/pyml-niigata-dify/dify_agent_retrieve2.png "Dify エージェント 検索結果確認2")

今回の会話では、DuckDuckGo側のRateLimitに引っかかりエラーとなった模様です。
つまりエージェントが正しく検索して調査できていないことがわかります。

エージェントに必ず検索結果からなる調査結果を返してほしい場合は、例えばエージェントに与えるプロンプト指示に「DuckDuckGo の検索に失敗した場合、失敗した理由のみを回答し、それ以外の一切を回答してはいけません。また、あなた自身の知識を回答に含めてはいけません。」等の内容を含めることで改善できる可能性があります。

![Dify エージェント 検索結果確認3](/images/books/pyml-niigata-dify/dify_agent_retrieve3.png "Dify エージェント 検索結果確認3")
